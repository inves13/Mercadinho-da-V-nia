<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mercadinho da Vani</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#2e8b57;
      --accent:#ffd400;
      --bg:#ffffff;
      --muted:#8b8b8b;
      --card-shadow: 0 10px 30px rgba(46,139,87,0.08);
      --nav-height:72px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Arial, sans-serif;
      background:linear-gradient(180deg,#f8fbf8 0%, #ffffff 60%);
      color:#111;
      padding-bottom: calc(var(--nav-height) + 12px);
    }

    .app{max-width:980px;margin:14px auto;padding:12px;}

    header{display:flex;align-items:center;gap:12px;padding:12px;border-radius:14px;background: linear-gradient(90deg, rgba(46,139,87,1) 0%, rgba(255,212,64,1) 100%);color:white;box-shadow: 0 8px 30px rgba(46,139,87,0.12);position:relative;overflow:hidden;}
    .brand{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,0.12);background: rgba(255,255,255,0.12);font-size:20px;}
    header h1{margin:0;font-size:18px;line-height:1;color:#fff}
    header .small{font-size:13px;color:rgba(255,255,255,0.90);opacity:0.95}

    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:var(--card-shadow);margin:14px 0;transition:transform .22s ease, box-shadow .22s ease;}
    .card--flat { box-shadow: none; }

    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;margin-top:8px;}
    .product{text-align:center;padding:10px;border-radius:12px;border:1px solid #f0f0f0;background: linear-gradient(180deg, #ffffff, #fbfffb);}
    .product img{width:100%;height:120px;object-fit:cover;border-radius:10px;display:block;margin-bottom:8px;background:#f6f6f6;}
    .product .title{font-weight:700;margin-bottom:6px;color:#183a2a}
    .product .price{font-weight:600;color:var(--primary);margin-bottom:8px}

    input[type="number"]{width:94px;border-radius:10px;border:1px solid #e9e9e9;padding:8px;text-align:center;outline:none;transition:box-shadow .12s ease, border-color .12s ease;}
    input[type="number"]:focus{box-shadow:0 6px 18px rgba(46,139,87,0.08);border-color:var(--primary);}

    .row{display:flex;gap:10px;align-items:center}
    .small{font-size:13px;color:var(--muted)}

    .checkout-row{display:flex;align-items:center;gap:12px;margin-top:10px;position: sticky;bottom: calc(var(--nav-height) + 12px);background:#fff;padding:12px 0 0 0;z-index:1000;}
    .total-box{font-weight:800;color:#183a2a}
    .btn{padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--primary),var(--accent));color:#111;box-shadow:0 8px 20px rgba(46,139,87,0.12);}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;border:1px solid #eee;color:#333;box-shadow:none;}

    .pix-block{border-radius:12px;padding:12px;color:#fff; background: linear-gradient(90deg,var(--primary),#2fb86a); word-break:break-word;}
    #ordersList .card{margin:8px 0;padding:10px;border-radius:12px}
    #profileImage{width:92px;height:92px;border-radius:12px;object-fit:cover;box-shadow:0 8px 20px rgba(0,0,0,0.06)}

    nav.bottom{position:fixed;left:12px;right:12px;bottom:12px;height:var(--nav-height);border-radius:16px;background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));display:flex;justify-content:space-around;align-items:center;padding:8px 12px;z-index:1200;box-shadow: 0 20px 40px rgba(20,60,30,0.08);backdrop-filter: blur(6px);}
    nav.bottom button{background:transparent;border:none;display:flex;flex-direction:column;align-items:center;font-weight:700;font-size:13px;color:var(--muted);cursor:pointer;}
    nav.bottom button .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:4px;}
    nav.bottom button.active{color:var(--primary)}
    nav.bottom button.active .icon{background: linear-gradient(90deg,var(--primary),var(--accent));color:#111;box-shadow: 0 8px 22px rgba(46,139,87,0.16);}

    #whatsapp-flutuante{position: fixed;width: 64px;height: 64px;bottom: calc(var(--nav-height) + 26px);right: 18px;background: linear-gradient(180deg,#25d366,#06b84b);border-radius: 16px;display:flex;align-items:center;justify-content:center;box-shadow: 0 12px 30px rgba(0,0,0,0.14);z-index:1300;}
    #whatsapp-flutuante img{width:34px;height:34px;}

    @media (max-width:520px){.product img{height:100px}.brand{width:48px;height:48px;font-size:18px}header h1{font-size:16px}nav.bottom{left:8px;right:8px}.products-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}input[type="number"]{width:78px}.container{padding:8px}}

    .page{transition:opacity .22s ease, transform .22s ease;}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">V</div>
      <div>
        <h1>Mercadinho da Vani</h1>
        <div class="small" id="greeting">Carregando...</div>
      </div>
      <div style="margin-left:auto">
        <button id="btnLogout" class="btn secondary" style="padding:8px 12px">Sair</button>
      </div>
    </header>

    <section id="dashboard">
      <div id="pageProducts" class="card page">
        <h3>Produtos</h3>
        <div id="productsList" class="products-grid"></div>
        <div class="checkout-row" style="margin-top:12px">
          <div class="total-box">Total: R$ <span id="cartTotal">0.00</span></div>
          <div style="margin-left:auto">
            <button id="btnCheckout" class="btn">Finalizar compra</button>
          </div>
        </div>
      </div>

      <div id="pageDeposit" class="card page hidden" style="text-align:center">
        <h3>Dep√≥sito via Pix</h3>
        <div class="pix-block" style="margin:12px 0;">
          <b>Chave Pix:</b><br>
          <span id="pixKey">00020126810014br.gov.bcb.pix01367afe98b1-ad17-4884-be4d-9a77d0d107ca0219mercadinho da Vania5204000053039865802BR5919Luis Nunes de Jesus6009Sao Paulo610901227-20062230519daqr727713149873566630468CD</span>
        </div>
        <button id="btnCopyPix" class="btn" style="background:linear-gradient(90deg,var(--accent),#ffd84a);">Copiar chave Pix</button>
      </div>

      <div id="pageOrders" class="card page hidden">
        <h3>Extrato de Pedidos</h3>
        <div id="ordersList">Nenhum pedido encontrado.</div>
      </div>

      <div id="pageProfile" class="card page hidden">
        <h3>Perfil</h3>
        <div class="row" style="align-items:flex-start">
          <img id="profileImage" src="1.png" alt="foto" />
          <div style="margin-left:12px">
            <div id="profileName" style="font-weight:700"></div>
            <div id="profileEmail" class="small"></div>
            <div id="profilePhone" class="small"></div> <!-- Exibi√ß√£o do telefone -->
            <div style="margin-top:8px">
              <button id="btnEditProfile" class="btn secondary">Editar perfil</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <nav class="bottom" role="navigation" aria-label="Menu inferior">
    <button data-page="products" class="active" aria-pressed="true">
      <div class="icon">üçé</div>
      <div>Produtos</div>
    </button>
    <button data-page="deposit">
      <div class="icon">üí∞</div>
      <div>Dep√≥sito</div>
    </button>
    <button data-page="orders">
      <div class="icon">üìú</div>
      <div>Extrato</div>
    </button>
    <button data-page="profile">
      <div class="icon">üë§</div>
      <div>Perfil</div>
    </button>
  </nav>

  <a id="whatsapp-flutuante" href="https://wa.me/5575999537162?text=Ol√°,+preciso+de+ajuda+com+meu+pedido+no+Mercadinho+da+Vani" target="_blank" title="Suporte no WhatsApp" rel="noopener">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" />
  </a>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyBNNCCbI8obZEOGtp1EcT7wn-_h6X_EPMY",
      authDomain: "ganheinvista.firebaseapp.com",
      databaseURL: "https://ganheinvista-default-rtdb.firebaseio.com",
      projectId: "ganheinvista",
      storageBucket: "ganheinvista.firebasestorage.app",
      messagingSenderId: "724834283527",
      appId: "1:724834283527:web:9e005772a2cddb2f76baa2",
      measurementId: "G-6P3MZJVMQR"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const products = [
      {id:'banana',name:'Banana (d√∫zia)',price:8.50,image:'2.png'},
      {id:'maca',name:'Ma√ß√£ (kg)',price:7.50,image:'3.png'},
      {id:'laranja',name:'Laranja (kg)',price:3.20,image:'4.png'},
      {id:'tangerina',name:'Tangerina (kg)',price:3.40,image:'5.png'},
      {id:'limao',name:'Lim√£o (kg)',price:4.00,image:'6.png'},
      {id:'abacate',name:'Abacate (kg)',price:6.50,image:'7.png'},
      {id:'goiaba',name:'Goiaba (kg)',price:5.00,image:'8.png'},
      {id:'uva',name:'Uva (kg)',price:12.00,image:'9.png'},
      {id:'abacaxi',name:'Abacaxi (un)',price:7.00,image:'10.png'},
      {id:'beterraba',name:'Beterraba (kg)',price:4.50,image:'11.png'},
      {id:'cenoura',name:'Cenoura (kg)',price:4.00,image:'12.png'},
      {id:'batatadoce',name:'Batata Doce (kg)',price:5.50,image:'13.png'},
      {id:'batatinha',name:'Batatinha (kg)',price:6.00,image:'14.png'},
      {id:'cebola_branca',name:'Cebola Branca (kg)',price:5.00,image:'15.png'},
      {id:'cebola_vermelha',name:'Cebola Vermelha (kg)',price:5.50,image:'16.png'},
      {id:'coentro',name:'Coentro (un)',price:1.50,image:'17.png'},
      {id:'alface',name:'Alface (un)',price:2.20,image:'30.png'},
      {id:'abobora',name:'Ab√≥bora (kg)',price:3.80,image:'19.png'},
      {id:'pepino',name:'Pepino (kg)',price:4.20,image:'20.png'},
      {id:'tomate',name:'Tomate (kg)',price:6.80,image:'21.png'},
      {id:'pimentao',name:'Piment√£o (kg)',price:5.50,image:'22.png'},
      {id:'quiabo',name:'Quiabo (kg)',price:8.50,image:'23.png'}
    ];

    let currentUser = null;
    let cart = {};

    const $ = id => document.getElementById(id);

    function formatBRL(val){ return Number(val || 0).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}); }

    auth.onAuthStateChanged(async u=>{
      if(!u){ window.location.href='index.html'; return; }
      currentUser = u;

      const snap = await db.ref('users/'+u.uid).once('value');
      const p = snap.val() || {};
      $('greeting').textContent = 'Bem-vindo, ' + (p.name || '');
      $('profileName').textContent = p.name || '';
      $('profileEmail').textContent = p.email || '';
      $('profilePhone').textContent = p.telefone || 'Telefone n√£o informado'; // Exibindo telefone corretamente
      $('profileImage').src = p.photoURL || 'avatar.png';

      renderProducts();
      loadOrders();
    });

    $('btnLogout').onclick = ()=> auth.signOut();

    function renderProducts(){
      const list = $('productsList');
      list.innerHTML = '';
      products.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'product';
        div.innerHTML = `
          <img src="${p.image}" alt="${p.name}" />
          <div class="title">${p.name}</div>
          <div class="price">R$ ${formatBRL(p.price)}</div>
          <div style="display:flex;gap:8px;justify-content:center;align-items:center;margin-top:6px;">
            <input type="number" step="0.01" min="0" placeholder="Qtd" data-id="${p.id}" />
          </div>
          <div style="margin-top:8px;font-size:13px"><b>Subtotal:</b> R$ <span data-sub="${p.id}">0.00</span></div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener('input', () => {
          const parsed = parseFloat(inp.value.replace(',', '.')) || 0;
          cart[inp.dataset.id] = parsed;
          updateTotal();
        });
        inp.addEventListener('focus', () => inp.select());
      });

      updateTotal();
    }

    function updateTotal(){
      let t = 0;
      products.forEach(p=>{
        const q = cart[p.id] || 0;
        const sub = (q * p.price);
        const el = document.querySelector('[data-sub="'+p.id+'"]');
        if(el) el.textContent = formatBRL(sub);
        t += sub;
      });
      $('cartTotal').textContent = formatBRL(t);
    }

    $('btnCheckout').onclick = async () => {
      if(!currentUser) return alert('Fa√ßa login antes');
      const items = products.filter(p => (cart[p.id]||0) > 0).map(p => ({ name:p.name, qty: cart[p.id], price: p.price, subtotal: p.price * cart[p.id] }));
      if(items.length === 0) return alert('Nenhum produto selecionado');
      const total = items.reduce((a,b)=>a+b.subtotal,0);
      await db.ref('orders/'+currentUser.uid).push({items, total, createdAt: new Date().toISOString()});
      alert('Pedido salvo! Voc√™ pode verificar ou cancelar no "Extrato".');
      cart = {}; renderProducts(); loadOrders();
    };

    async function loadOrders(){
      if(!currentUser) return;
      const out = $('ordersList');
      out.innerHTML = 'Carregando...';
      const snap = await db.ref('orders/'+currentUser.uid).once('value');
      const v = snap.val();
      if(!v){ out.innerHTML = 'Nenhum pedido.'; return; }
      out.innerHTML = '';
      Object.entries(v).forEach(([key,o])=>{
        const card = document.createElement('div'); card.className='card';
        const itemsHtml = o.items.map(i=> `${i.qty}x ${i.name} ‚Äî R$ ${formatBRL(i.subtotal)}` ).join('<br>');
        card.innerHTML = `
          <b>${new Date(o.createdAt).toLocaleString()}</b><br>
          ${itemsHtml}<br>
          <b>Total:</b> R$ ${formatBRL(o.total)}<br>
          <button data-id="${key}" class="btnCancel" style="margin-top:8px;background:#f33;color:#fff;border:none;padding:6px 10px;border-radius:8px">Cancelar Pedido</button>
        `;
        out.appendChild(card);
      });

      document.querySelectorAll('.btnCancel').forEach(btn=>{
        btn.onclick = async ()=>{
          if(confirm('Tem certeza que deseja cancelar este pedido?')){
            await db.ref('orders/'+currentUser.uid+'/'+btn.dataset.id).remove();
            alert('Pedido cancelado com sucesso.');
            loadOrders();
          }
        };
      });
    }

    $('btnCopyPix').onclick = ()=> {
      navigator.clipboard.writeText($('pixKey').textContent).then(()=> {
        const original = $('btnCopyPix').textContent;
        $('btnCopyPix').textContent = 'Copiado ‚úî';
        setTimeout(()=> $('btnCopyPix').textContent = original, 1500);
      });
    };

    const navButtons = document.querySelectorAll('nav.bottom button');
    navButtons.forEach(b=>{
      b.addEventListener('click', () => {
        const page = b.dataset.page;
        ['pageProducts','pageDeposit','pageOrders','pageProfile'].forEach(id=> document.getElementById(id)?.classList.add('hidden'));
        navButtons.forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-pressed','false'); });
        b.classList.add('active'); b.setAttribute('aria-pressed','true');
        const showId = page === 'products' ? 'pageProducts'
                      : page === 'deposit' ? 'pageDeposit'
                      : page === 'orders' ? 'pageOrders'
                      : 'pageProfile';
        document.getElementById(showId)?.classList.remove('hidden');
      });
    });

    (function initNavActive(){
      document.querySelector('nav.bottom button.active')?.click();
    })();
  </script>
</body>
</html>
