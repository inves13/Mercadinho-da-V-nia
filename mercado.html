<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mercadinho da Vani</title>
  <style>
    :root{--primary:#2e8b57;--accent:#ffd400;--bg:#f6f7f3}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111}
    .container{max-width:980px;margin:16px auto;padding:12px}
    header{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .product{text-align:center;padding:10px;border-radius:10px;border:1px solid #eee}
    .product img{width:100%;height:120px;object-fit:cover;border-radius:8px}
    input,button{padding:8px;border-radius:8px;border:1px solid #e6e6e6}
    button{cursor:pointer}
    .row{display:flex;gap:10px;align-items:center}
    nav.bottom{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0}
    nav.bottom button{background:transparent;border:none;font-weight:700;display:flex;flex-direction:column;align-items:center;font-size:14px;color:#2e8b57}
    nav.bottom span{font-size:20px}
    .hidden{display:none}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="width:44px;height:44px;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">V</div>
      <div>
        <h1>Mercadinho da Vani</h1>
        <div class="small" id="greeting">Carregando...</div>
      </div>
      <div style="margin-left:auto">
        <button id="btnLogout">Sair</button>
      </div>
    </header>

    <section id="dashboard">
      <div id="pageProducts" class="card">
        <h3>Produtos</h3>
        <div id="productsList" class="products-grid"></div>
        <div class="row" style="margin-top:12px">
          <div style="font-weight:700">Total: R$ <span id="cartTotal">0.00</span></div>
          <div style="margin-left:auto"><button id="btnCheckout">Finalizar compra</button></div>
        </div>
      </div>

      <div id="pageDeposit" class="card hidden" style="text-align:center">
        <h3>Dep√≥sito via Pix</h3>
        <div style="background:var(--primary);color:#fff;padding:14px;border-radius:12px;margin:12px 0;word-break:break-all">
          <b>Chave Pix:</b><br>
          <span id="pixKey">00020126810014br.gov.bcb.pix01367afe98b1-ad17-4884-be4d-9a77d0d107ca0219mercadinho da Vania5204000053039865802BR5919Luis Nunes de Jesus6009Sao Paulo610901227-20062230519daqr727713149873566630468CD</span>
        </div>
        <button id="btnCopyPix" style="background:var(--accent);border:none;padding:10px 18px;font-weight:700;border-radius:8px;cursor:pointer">Copiar chave Pix</button>
      </div>

      <div id="pageOrders" class="card hidden">
        <h3>Extrato de Pedidos</h3>
        <div id="ordersList">Nenhum pedido encontrado.</div>
      </div>

      <div id="pageProfile" class="card hidden">
        <h3>Perfil</h3>
        <div class="row">
          <img id="profileImage" src="avatar.png" alt="foto" style="width:92px;height:92px;border-radius:10px;object-fit:cover" />
          <div style="margin-left:12px">
            <div id="profileName" style="font-weight:700"></div>
            <div id="profileEmail" class="small"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <nav class="bottom">
    <button data-page="products"><span>üçé</span>Produtos</button>
    <button data-page="deposit"><span>üí∞</span>Dep√≥sito</button>
    <button data-page="orders"><span>üìú</span>Extrato</button>
    <button data-page="profile"><span>üë§</span>Perfil</button>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyBNNCCbI8obZEOGtp1EcT7wn-_h6X_EPMY",
      authDomain: "ganheinvista.firebaseapp.com",
      databaseURL: "https://ganheinvista-default-rtdb.firebaseio.com",
      projectId: "ganheinvista",
      storageBucket: "ganheinvista.firebasestorage.app",
      messagingSenderId: "724834283527",
      appId: "1:724834283527:web:9e005772a2cddb2f76baa2",
      measurementId: "G-6P3MZJVMQR"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const products = [
      {id:'banana',name:'Banana (d√∫zia)',price:8.50,image:'2.png'},
      {id:'maca',name:'Ma√ß√£ (kg)',price:7.50,image:'3.png'},
      {id:'laranja',name:'Laranja (kg)',price:3.20,image:'4.png'},
      {id:'tangerina',name:'Tangerina (kg)',price:3.40,image:'5.png'},
      {id:'limao',name:'Lim√£o (kg)',price:4.00,image:'6.png'},
      {id:'abacate',name:'Abacate (kg)',price:6.50,image:'7.png'},
      {id:'goiaba',name:'Goiaba (kg)',price:5.00,image:'8.png'},
      {id:'uva',name:'Uva (kg)',price:12.00,image:'9.png'},
      {id:'abacaxi',name:'Abacaxi (un)',price:7.00,image:'10.png'},
      {id:'beterraba',name:'Beterraba (kg)',price:4.50,image:'11.png'},
      {id:'cenoura',name:'Cenoura (kg)',price:4.00,image:'12.png'},
      {id:'batatadoce',name:'Batata Doce (kg)',price:5.50,image:'13.png'},
      {id:'batatinha',name:'Batatinha (kg)',price:6.00,image:'14.png'},
      {id:'cebola_branca',name:'Cebola Branca (kg)',price:5.00,image:'15.png'},
      {id:'cebola_vermelha',name:'Cebola Vermelha (kg)',price:5.50,image:'16.png'},
      {id:'coentro',name:'Coentro (un)',price:1.50,image:'17.png'},
      {id:'alface',name:'Alface (un)',price:2.20,image:'30.png'},
      {id:'abobora',name:'Ab√≥bora (kg)',price:3.80,image:'19.png'},
      {id:'pepino',name:'Pepino (kg)',price:4.20,image:'20.png'},
      {id:'tomate',name:'Tomate (kg)',price:6.80,image:'21.png'},
      {id:'pimentao',name:'Piment√£o (kg)',price:5.50,image:'22.png'},
      {id:'quiabo',name:'Quiabo (kg)',price:7.30,image:'20.png'}
    ];

    let currentUser = null;
    let cart = {};
    const $ = id => document.getElementById(id);

    auth.onAuthStateChanged(async u=>{
      if(!u){ window.location.href='index.html'; return; }
      currentUser = u;
      const snap = await db.ref('users/'+u.uid).once('value');
      const p = snap.val() || {};
      $('greeting').textContent = 'Bem-vindo, ' + (p.name||'');
      $('profileName').textContent = p.name || '';
      $('profileEmail').textContent = p.email || '';
      $('profileImage').src = 'avatar.png';
      renderProducts();
      loadOrders();
    });

    $('btnLogout').onclick = ()=> auth.signOut();

    function renderProducts(){
      const list = $('productsList');
      list.innerHTML = '';
      products.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'product';
        div.innerHTML = `
          <img src="${p.image}" alt="${p.name}" />
          <div style="font-weight:700">${p.name}</div>
          <div>R$ ${p.price.toFixed(2)}</div>
          <input type="number" min="0" placeholder="Qtd" data-id="${p.id}" style="width:80px;margin-top:8px" />
          <div style="margin-top:8px"><b>Subtotal:</b> R$ <span data-sub="${p.id}">0.00</span></div>
        `;
        list.appendChild(div);
      });
      list.querySelectorAll('input').forEach(inp=>{
        inp.oninput = () => { cart[inp.dataset.id] = +inp.value || 0; updateTotal(); }
      });
      updateTotal();
    }

    function updateTotal(){
      let t = 0;
      products.forEach(p=>{
        const q = cart[p.id]||0;
        const sub = q * p.price;
        const el = document.querySelector('[data-sub="'+p.id+'"]');
        if(el) el.textContent = sub.toFixed(2);
        t += sub;
      });
      $('cartTotal').textContent = t.toFixed(2);
    }

    $('btnCheckout').onclick = async () => {
      if(!currentUser) return alert('Fa√ßa login antes');
      const items = products.filter(p => (cart[p.id]||0) > 0).map(p => ({ name:p.name, qty: cart[p.id], price: p.price, subtotal: p.price * cart[p.id] }));
      if(items.length === 0) return alert('Nenhum produto selecionado');
      const total = items.reduce((a,b)=>a+b.subtotal,0);
      const ref = await db.ref('orders/'+currentUser.uid).push({items, total, createdAt: new Date().toISOString()});
      alert('Pedido salvo! Voc√™ pode verificar ou cancelar no "Extrato".');
      cart = {}; renderProducts(); loadOrders();
    };

    async function loadOrders(){
      if(!currentUser) return;
      const out = $('ordersList');
      out.innerHTML = 'Carregando...';
      const snap = await db.ref('orders/'+currentUser.uid).once('value');
      const v = snap.val();
      if(!v){ out.innerHTML = 'Nenhum pedido.'; return; }
      out.innerHTML = '';
      Object.entries(v).forEach(([key,o])=>{
        const card = document.createElement('div'); card.className='card';
        const itemsHtml = o.items.map(i=> `${i.qty}x ${i.name} ‚Äî R$ ${i.subtotal.toFixed(2)}` ).join('<br>');
        card.innerHTML = `
          <b>${new Date(o.createdAt).toLocaleString()}</b><br>
          ${itemsHtml}<br>
          <b>Total:</b> R$ ${o.total.toFixed(2)}<br>
          <button data-id="${key}" class="btnCancel" style="margin-top:8px;background:#f33;color:#fff;border:none;padding:6px 10px;border-radius:8px">Cancelar Pedido</button>
        `;
        out.appendChild(card);
      });

      document.querySelectorAll('.btnCancel').forEach(btn=>{
        btn.onclick = async ()=>{
          if(confirm('Tem certeza que deseja cancelar este pedido?')){
            await db.ref('orders/'+currentUser.uid+'/'+btn.dataset.id).remove();
            alert('Pedido cancelado com sucesso.');
            loadOrders();
          }
        };
      });
    }

    $('btnCopyPix').onclick = ()=> {
      const k = $('pixKey').textContent;
      navigator.clipboard.writeText(k).then(()=> alert('Chave Pix copiada!'));
    };

    document.querySelectorAll('nav.bottom button').forEach(b=>{
      b.onclick = ()=>{
        const page = b.dataset.page;
        ['pageProducts','pageDeposit','pageOrders','pageProfile'].forEach(id=> $(id).classList.add('hidden'));
        if(page === 'products') $('pageProducts').classList.remove('hidden');
        if(page === 'deposit') $('pageDeposit').classList.remove('hidden');
        if(page === 'orders') $('pageOrders').classList.remove('hidden');
        if(page === 'profile') $('pageProfile').classList.remove('hidden');
      };
    });
  </script>
</body>
</html>
